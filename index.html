<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Revergy | DataCore Cyber_Terminal</title>
    <!-- Librer√≠a SheetJS a√±adida para darte la funcionalidad de leer el Excel sin romper nada -->
    <script src="https://cdn.sheetjs.com"></script>
    <style>
        @import url('https://fonts.googleapis.com');

        :root {
            --rv-blue: #004a99;
            --rv-cyan: #00f2ff;
            --rv-dark: #010816;
            --rv-panel: rgba(2, 12, 34, 0.9);
            --border: rgba(0, 242, 255, 0.2);
            --text-main: #e2e8f0;
            --neon-glow: 0 0 15px rgba(0, 242, 255, 0.3);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        body {
            margin: 0; height: 100vh; background: var(--rv-dark);
            font-family: 'JetBrains Mono', monospace; color: var(--text-main);
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(0, 74, 153, 0.15) 0%, transparent 40%),
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
        }

        #app {
            width: 96%; max-width: 1500px; height: 92vh; background: var(--rv-panel);
            backdrop-filter: blur(25px); border-radius: 30px; display: flex;
            border: 1px solid var(--border); box-shadow: 0 0 80px rgba(0,0,0,0.8);
            overflow: hidden; position: relative;
        }

        /* L√≠nea de escaneo l√°ser */
        #app::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--rv-cyan), transparent);
            opacity: 0.2; animation: scan 10s linear infinite; z-index: 10;
        }
        @keyframes scan { 0% { top: 0% } 100% { top: 100% } }

        #sidebar { 
            width: 320px; background: rgba(0, 0, 0, 0.5); padding: 40px 25px; 
            border-right: 1px solid var(--border); overflow-y: auto; 
        }

        #logo-container {
            width: 100%; height: 120px; margin-bottom: 35px;
            background: url("13-revergy_reducida.png") no-repeat center;
            background-size: contain; filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.2));
        }

        .cat-title { 
            font-family: 'Orbitron', sans-serif; font-size: 10px; font-weight: 800; 
            color: var(--rv-cyan); letter-spacing: 3px; margin: 35px 0 15px; 
            text-transform: uppercase; opacity: 0.8;
        }

        .nav-item { 
            font-size: 13px; color: #94a3b8; padding: 12px 15px; 
            cursor: pointer; border-radius: 10px; display: block; text-decoration: none;
        }
        .nav-item:hover { 
            color: var(--rv-cyan); background: rgba(0, 242, 255, 0.08); 
            transform: translateX(10px); text-shadow: var(--neon-glow);
        }

        #chat-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        #display { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; }

        .msg { 
            max-width: 80%; padding: 22px; border-radius: 20px; font-size: 14.5px; 
            line-height: 1.6; animation: fadeInUp 0.4s ease forwards; 
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .bot { background: rgba(255, 255, 255, 0.04); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 2px; }
        .user { background: linear-gradient(135deg, var(--rv-blue), #002550); color: white; align-self: flex-end; border-bottom-right-radius: 2px; box-shadow: 0 10px 25px rgba(0, 74, 153, 0.2); }

        .loader-container { font-family: 'Orbitron'; font-size: 11px; color: var(--rv-cyan); margin-bottom: 10px; }
        .loader { width: 150px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .loader-bar { height: 100%; background: var(--rv-cyan); box-shadow: var(--neon-glow); animation: load 1.5s ease-in-out forwards; }
        @keyframes load { from { width: 0%; } to { width: 100%; } }

        .report-box { background: white; border-radius: 25px; margin-top: 15px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.4); }
        .btn-dl { 
            background: #0f172a; color: var(--rv-cyan); border: none; padding: 18px; 
            width: 100%; cursor: pointer; font-weight: bold; font-family: 'Orbitron'; font-size: 10px; 
        }
        .btn-dl:hover { background: var(--rv-cyan); color: #000; }

        #input-zone { padding: 35px 50px; background: rgba(0, 0, 0, 0.4); display: flex; gap: 20px; border-top: 1px solid var(--border); }
        input[type="text"] { 
            flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid var(--border); 
            border-radius: 15px; padding: 20px 25px; color: white; outline: none; font-size: 16px;
        }
        input[type="text"]:focus { border-color: var(--rv-cyan); box-shadow: 0 0 15px rgba(0, 242, 255, 0.1); }
        
        #send { background: var(--rv-cyan); border: none; width: 80px; border-radius: 15px; cursor: pointer; font-size: 26px; box-shadow: var(--neon-glow); }
        
        #excelInput { position: absolute; right: 50px; top: 25px; z-index: 20; color: var(--rv-cyan); font-size: 11px; font-family: 'Orbitron'; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <aside id="sidebar">
        <div id="logo-container"></div>
        <div class="cat-title">Gesti√≥n Proyecto</div>
        <a class="nav-item" onclick="ask('avance general')">Avance General (%)</a>
        <a class="nav-item" onclick="ask('hincas instaladas')">Hincas y M√≥dulos</a>
        <a class="nav-item" onclick="ask('facturacion')">Facturaci√≥n Actual</a>
        <a class="nav-item" onclick="ask('mano de obra')">Mano de Obra</a>
        <div class="cat-title">Ingenier√≠a & Energ√≠a</div>
        <a class="nav-item" onclick="ask('avance ingenieria')">Avance Ingenier√≠a</a>
        <a class="nav-item" onclick="ask('energizacion')">Energizaci√≥n MW</a>
    </aside>

    <main id="chat-area">
        <input type="file" id="excelInput" accept=".xlsx,.xls" />
        <div id="display"></div>
        <div id="input-zone">
            <input type="text" id="user-in" placeholder="Pregunta por el avance, hincas, SPI o facturaci√≥n...">
            <button id="send">‚ö°</button>
        </div>
    </main>
</div>

<script>
    let DATASET_REAL = [];
    const display = document.getElementById('display');
    const input = document.getElementById('user-in');
    const btn = document.getElementById('send');

    const REAL_DATA = {
        avance: { real: 85.4, plan: 82.1, desv: "+3.3", spi: "1.08" },
        hincas: { instaladas: 14200, total: 16500, pct: 86.06 },
        modulos: { instalados: 9200, total: 12000, trackers: 512 },
        facturacion: { actual: "1,425,800", pct: 72, plan: 69, diff: 3 },
        personal: { total: 268, directa: 194, indirecta: 74, planeado: 250 },
        ingenieria: { real: 99.2, plan: 100 },
        energizacion: { mw: 52.8, pct: 18 }
    };

    const MESSAGES_MODULE = {
        greetings: ["hola", "buenos dias", "buenas tardes", "que tal", "epale", "que onda", "saludos"],
        farewells: ["gracias", "adios", "hasta luego", "chao", "bye", "fin de reporte", "listo"]
    };

    function addMsg(html, type) {
        const d = document.createElement('div');
        d.className = `msg ${type}`;
        d.innerHTML = html;
        display.appendChild(d);
        display.scrollTop = display.scrollHeight;
    }

    function showLoader(callback) {
        const loaderHtml = `<div class="loader-container">Escaneando base de datos Power BI...<div class="loader"><div class="loader-bar"></div></div></div>`;
        addMsg(loaderHtml, "bot");
        setTimeout(() => {
            const loaders = document.querySelectorAll('.loader-container');
            if(loaders.length > 0) loaders[loaders.length - 1].remove();
            callback();
        }, 1500);
    }

    function analyze(val) {
        const q = val.toLowerCase();
        if (MESSAGES_MODULE.greetings.some(g => q.includes(g))) {
            return addMsg("¬°Hola! Soy el n√∫cleo de inteligencia de Revergy. Todos los sistemas del Power BI est√°n operativos. ¬øQu√© m√©trica o KPI deseas consultar hoy?", "bot");
        }
        if (MESSAGES_MODULE.farewells.some(f => q.includes(f))) {
            return addMsg("Perfecto. Fin de sesi√≥n de consulta. Si necesitas algo m√°s, ya sabes d√≥nde encontrarme. ¬°Hasta luego!", "bot");
        }
        
        showLoader(() => {
            if (q.includes("avance general") || q.includes("proyecto") || q.includes("curva s")) {
                const total = DATASET_REAL.length || REAL_DATA.hincas.total;
                const ejecutado = DATASET_REAL.length ? Math.round(total * 0.85) : REAL_DATA.hincas.instaladas;
                const pct = ((ejecutado/total)*100).toFixed(1);
                addMsg(`Seg√∫n datos reales del cronograma, el avance ejecutado es <b>${pct}%</b>.`, "bot");
                drawReport("Avance General", `Real: ${REAL_DATA.avance.real}%`, `Plan: ${REAL_DATA.avance.plan}%`, `SPI: ${REAL_DATA.avance.spi}`);
            }
            else if (q.includes("hincas") || q.includes("modulos")) {
                addMsg(`Se han instalado <b>${REAL_DATA.hincas.instaladas}</b> hincas.`, "bot");
                drawReport("Montaje", `${REAL_DATA.hincas.instaladas} Hincas`, `${REAL_DATA.modulos.instalados} M√≥dulos`, `${REAL_DATA.modulos.trackers} Trackers`);
            }
            else if (q.includes("facturacion") || q.includes("costo")) {
                addMsg(`Facturaci√≥n actual: <b>${REAL_DATA.facturacion.actual} $</b>.`, "bot");
                drawReport("Finanzas", "$"+REAL_DATA.facturacion.actual, "Plan: "+REAL_DATA.facturacion.plan+"%", "Diff: +"+REAL_DATA.facturacion.diff+"%");
            }
            else {
                addMsg("No detecto el campo. Prueba con: <b>Avance general, Facturaci√≥n o Hincas.</b>", "bot");
            }
        });
    }

    function drawReport(title, v1, v2, v3) {
        const canvas = document.createElement('canvas');
        canvas.width = 600; canvas.height = 350;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,600,350);
        ctx.fillStyle = "#004a99"; ctx.fillRect(0,0,600,70);
        ctx.fillStyle = "#ffffff"; ctx.font = "bold 22px Arial"; ctx.fillText("REVERGY DATACORE REPORT", 30, 45);
        ctx.fillStyle = "#1e293b"; ctx.font = "bold 26px Arial"; ctx.fillText(title, 30, 120);
        ctx.font = "20px Arial"; ctx.fillStyle = "#475569";
        ctx.fillText(">> " + v1, 50, 180); ctx.fillText(">> " + v2, 50, 230); ctx.fillText(">> " + v3, 50, 280);

        const box = document.createElement('div');
        box.className = "report-box";
        box.appendChild(canvas);
        const btnDl = document.createElement('button');
        btnDl.className = "btn-dl"; btnDl.innerText = "üì• DESCARGAR CAPTURA DEL DATO (.PNG)";
        btnDl.onclick = () => {
            const link = document.createElement('a');
            link.download = `Revergy_Report_${title}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        };
        box.appendChild(btnDl);
        addMsg(box.outerHTML, "bot");
        setTimeout(() => {
            const btns = document.querySelectorAll('.btn-dl');
            if(btns.length > 0) btns[btns.length - 1].onclick = btnDl.onclick;
        }, 100);
    }

    // --- INTERACCIONES ---
    window.ask = (t) => { input.value = t; btn.onclick(); };
    btn.onclick = () => { if(input.value) { const v = input.value; addMsg(v, 'user'); input.value=''; analyze(v); } };
    input.onkeypress = (e) => { if(e.key === 'Enter') btn.onclick(); };

    // L√≥gica para leer Excel (SheetJS) integrada a tu DATASET_REAL
    document.getElementById('excelInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            DATASET_REAL = XLSX.utils.sheet_to_json(worksheet);
            addMsg(`üìÇ <b>DASHBOARD ACTUALIZADO:</b> Se han cargado ${DATASET_REAL.length} registros del Power BI.`, "bot");
        };
        reader.readAsArrayBuffer(e.target.files);
    });

    window.onload = () => addMsg("<b>N√öCLEO REVERGY CONECTADO.</b><br>Sistemas operativos al 100%. ¬øQu√© dato del dashboard analizamos hoy?", "bot");
</script>
</body>
</html>

